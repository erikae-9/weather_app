<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>Weather Dashboard</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<style>
* { 
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: #f1f5f9;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

.container { 
    max-width: 100%;
    margin: 0 auto;
    padding: 12px;
    overflow-x: hidden;
}

h1 {
    font-size: 1.5rem;
    margin: 0 0 8px 0;
    font-weight: 600;
}

.subtitle {
    color: #94a3b8;
    margin-bottom: 15px;
    font-size: 0.85rem;
}

.location-section {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.city-search-section {
    margin-bottom: 12px;
}

.city-search-wrapper {
    display: flex;
    gap: 8px;
}

.city-search-input {
    flex: 1;
    padding: 12px;
    border: 2px solid #334155;
    border-radius: 8px;
    background: #1e293b;
    color: #e2e8f0;
    font-size: 0.9rem;
    font-family: inherit;
}

.city-search-input:focus {
    outline: none;
    border-color: #3b82f6;
}

.city-search-btn {
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: #3b82f6;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s;
    touch-action: manipulation;
    white-space: nowrap;
}

.city-search-btn:active {
    transform: scale(0.95);
}

.city-search-btn:disabled {
    background: #475569;
    cursor: not-allowed;
}

.preset-cities {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 8px;
    margin-bottom: 12px;
}

.city-btn {
    padding: 12px 8px;
    border: 2px solid #334155;
    border-radius: 8px;
    cursor: pointer;
    background: #1e293b;
    color: #e2e8f0;
    font-weight: 500;
    transition: all 0.2s;
    font-size: 0.9rem;
    text-align: center;
    touch-action: manipulation;
}

.city-btn:active {
    transform: scale(0.95);
}

.city-btn.active {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
}

.custom-location-toggle {
    width: 100%;
    padding: 10px;
    background: transparent;
    border: 2px dashed #475569;
    border-radius: 8px;
    color: #94a3b8;
    font-size: 0.85rem;
    cursor: pointer;
    margin-bottom: 10px;
    touch-action: manipulation;
}

.custom-inputs {
    display: none;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 10px;
}

.custom-inputs.visible {
    display: grid;
}

.input-group {
    display: flex;
    flex-direction: column;
}

.input-group label {
    font-size: 0.75rem;
    color: #94a3b8;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.input-group input {
    padding: 10px;
    border: 2px solid #334155;
    border-radius: 8px;
    background: #1e293b;
    color: #e2e8f0;
    font-size: 0.9rem;
    font-family: inherit;
}

.input-group input:focus {
    outline: none;
    border-color: #3b82f6;
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.fetch-btn {
    padding: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: #3b82f6;
    color: white;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.2s;
    touch-action: manipulation;
}

.fetch-btn:active {
    transform: scale(0.95);
}

.fetch-btn:disabled {
    background: #475569;
    cursor: not-allowed;
}

.geolocation-btn {
    padding: 12px;
    border: 2px solid #10b981;
    border-radius: 8px;
    cursor: pointer;
    background: transparent;
    color: #10b981;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.2s;
    touch-action: manipulation;
}

.geolocation-btn:active {
    transform: scale(0.95);
    background: rgba(16, 185, 129, 0.1);
}

.loading {
    text-align: center;
    padding: 30px;
    font-size: 1.1rem;
    color: #94a3b8;
}

.error {
    background: #7f1d1d;
    border: 2px solid #991b1b;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
    color: #fecaca;
    font-size: 0.9rem;
}

.controls {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    margin-bottom: 15px;
}

.controls button {
    padding: 10px 8px;
    border: 2px solid #334155;
    border-radius: 8px;
    cursor: pointer;
    background: #1e293b;
    color: #e2e8f0;
    font-weight: 500;
    transition: all 0.2s;
    font-size: 0.85rem;
    touch-action: manipulation;
}

.controls button:active {
    transform: scale(0.95);
}

.controls button.active {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
}

.risk-panel-horizontal {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    margin-bottom: 15px;
}

.risk-panel-horizontal h2 {
    margin: 0 0 12px 0;
    font-size: 1.1rem;
    color: #f1f5f9;
    border-bottom: 2px solid #475569;
    padding-bottom: 8px;
}

.risk-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.risk-item {
    padding: 10px;
    background: rgba(15, 23, 42, 0.6);
    border-radius: 8px;
    border-left: 4px solid;
}

.risk-item.low { border-left-color: #22c55e; }
.risk-item.medium { border-left-color: #f59e0b; }
.risk-item.high { border-left-color: #ef4444; }

.risk-label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    margin-bottom: 4px;
    font-weight: 600;
}

.risk-icon {
    font-size: 1.1rem;
}

.risk-time {
    font-size: 0.95rem;
    color: #e2e8f0;
    font-weight: 500;
}

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    overflow: hidden;
    margin-bottom: 15px;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
    width: 100%;
}

.summary-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    min-width: 0;
    overflow: hidden;
}

.summary-card h3 {
    margin: 0 0 10px 0;
    font-size: 0.75rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: #f1f5f9;
}

.summary-range {
    font-size: 0.75rem;
    color: #cbd5e1;
}

/* Data Table Styles */
.data-table-section {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.data-table-section h2 {
    margin: 0 0 12px 0;
    font-size: 1.1rem;
    color: #f1f5f9;
    border-bottom: 2px solid #475569;
    padding-bottom: 8px;
}

.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.weather-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
    background: rgba(15, 23, 42, 0.6);
    border-radius: 8px;
    overflow: hidden;
}

.weather-table th {
    background: rgba(59, 130, 246, 0.2);
    color: #f1f5f9;
    padding: 10px 8px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #475569;
    position: sticky;
    top: 0;
    white-space: nowrap;
}

.weather-table td {
    padding: 8px;
    border-bottom: 1px solid #334155;
    color: #e2e8f0;
}

.weather-table tr:last-child td {
    border-bottom: none;
}

.weather-table tr:hover {
    background: rgba(59, 130, 246, 0.1);
}

.weather-symbol {
    display: flex;
    align-items: center;
    gap: 6px;
}

.weather-icon {
    font-size: 1.2rem;
}

@media (max-width: 640px) {
    .weather-table {
        font-size: 0.75rem;
    }
    
    .weather-table th,
    .weather-table td {
        padding: 6px 4px;
    }
}
</style>
</head>
<body>
<div class="container">
    <h1>üå§Ô∏è Eriks v√§derapp</h1>
    <div class="subtitle">Detaljerade v√§derprognoser</div>
    
    <div class="location-section">
        <div class="city-search-section">
            <div class="city-search-wrapper">
                <input 
                    type="text" 
                    id="citySearchInput" 
                    class="city-search-input" 
                    placeholder="S√∂k stad"
                    onkeypress="if(event.key === 'Enter') searchCity()"
                />
                <button class="city-search-btn" onclick="searchCity()">üîç S√∂k</button>
            </div>
        </div>
        
        <div class="preset-cities">
            <button class="city-btn" onclick="selectCity('Skellefte√•', 64.762519, 20.923440)">Skellefte√•</button>
            <button class="city-btn" onclick="selectCity('Stockholm', 59.3293, 18.0686)">Stockholm</button>
            <button class="city-btn" onclick="selectCity('Skarja, Sarek', 67.377503, 17.644642)">Skarja, Sarek</button>
            <button class="city-btn" onclick="selectCity('Sjungande dalen', 64.762528, 20.923429)">Sjungande dalen</button>
            <button class="city-btn" onclick="selectCity('Longyearbyen', 78.224083,15.62873)">Longyearbyen</button>
        </div>
        
        <button class="custom-location-toggle" onclick="toggleCustomInputs()">
            ‚öôÔ∏è Eller skriv in koordinater manuellt
        </button>
        
        <div id="customInputs" class="custom-inputs">
            <div class="input-group">
                <label for="lat">Latitude</label>
                <input type="number" id="lat" step="0.0001" value="64.762519">
            </div>
            <div class="input-group">
                <label for="lon">Longitude</label>
                <input type="number" id="lon" step="0.0001" value="20.923440">
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="fetch-btn" onclick="fetchWeather()">üì° H√§mta v√§der</button>
            <button class="geolocation-btn" onclick="useGeolocation()">üìç Anv√§nd min plats</button>
        </div>
    </div>
    
    <div id="error"></div>
    <div id="loading" class="loading" style="display:none;">Laddar v√§derdata...</div>
    
    <div id="content" style="display:none;">
        <div class="controls">
            <button id="btn-6" onclick="setRange(6)">6h</button>
            <button id="btn-12" onclick="setRange(12)">12h</button>
            <button id="btn-24" onclick="setRange(24)">24h</button>
            <button id="btn-48" onclick="setRange(48)">48h</button>
            <button id="btn-all" onclick="setRange(9999)">Samtliga</button>
        </div>
        
        <div id="riskPanel" class="risk-panel-horizontal"></div>
        
        <div class="chart-container">
            <div id="tempChart"></div>
        </div>
        
        <div class="chart-container">
            <div id="windChart"></div>
        </div>
        
        <div class="chart-container">
            <div id="precipChart"></div>
        </div>
        
        <div class="summary-cards">
            <div class="summary-card">
                <h3>‚òÅÔ∏è Molnt√§cke</h3>
                <div class="summary-value" id="cloudValue">-</div>
                <div class="summary-range" id="cloudRange">-</div>
                <div id="cloudSpark"></div>
            </div>
            <div class="summary-card">
                <h3>üíß Luftfuktighet</h3>
                <div class="summary-value" id="humidityValue">-</div>
                <div class="summary-range" id="humidityRange">-</div>
                <div id="humiditySpark"></div>
            </div>
            <div class="summary-card">
                <h3>üå°Ô∏è Lufttryck</h3>
                <div class="summary-value" id="pressureValue">-</div>
                <div class="summary-range" id="pressureRange">-</div>
                <div id="pressureSpark"></div>
            </div>
            <div class="summary-card">
                <h3>‚òÄÔ∏è UV Index</h3>
                <div class="summary-value" id="uvValue">-</div>
                <div class="summary-range" id="uvRange">-</div>
                <div id="uvSpark"></div>
            </div>
        </div>
        
        <div class="data-table-section">
            <h2>üìä Detaljer</h2>
            <div class="table-wrapper">
                <table class="weather-table" id="weatherDataTable">
                    <thead>
                        <tr>
                            <th>Tid</th>
                            <th>V√§der</th>
                            <th>Temp (¬∞C)</th>
                            <th>K√§nns (¬∞C)</th>
                            <th>Medelvind (m/s)</th>
                            <th>Vindrikt.</th>
                            <th>Byvind (m/s)</th>
                            <th>Nederb (mm)</th>
                            <th>Moln (%)</th>
                            <th>Luftfukt. (%)</th>
                            <th>Tryck (hPa)</th>
                            <th>UV</th>
                        </tr>
                    </thead>
                    <tbody id="weatherDataBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let weatherData = null;
let currentRange = 24;
let currentCity = 'Skellefte√•';

function toggleCustomInputs() {
    const inputs = document.getElementById('customInputs');
    inputs.classList.toggle('visible');
}

async function searchCity() {
    const cityName = document.getElementById('citySearchInput').value.trim();
    if (!cityName) {
        showError('Please enter a city name');
        return;
    }
    
    const searchBtn = document.querySelector('.city-search-btn');
    searchBtn.disabled = true;
    searchBtn.textContent = 'üîç Searching...';
    
    try {
        // Use Nominatim API for geocoding
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&format=json&limit=1`,
            {
                headers: {
                    'User-Agent': 'WeatherDashboard/1.0'
                }
            }
        );
        
        if (!response.ok) throw new Error('Geocoding failed');
        
        const data = await response.json();
        
        if (data.length === 0) {
            showError(`City "${cityName}" not found. Try a different name or spelling.`);
            return;
        }
        
        const location = data[0];
        const lat = parseFloat(location.lat);
        const lon = parseFloat(location.lon);
        const displayName = location.display_name.split(',')[0]; // Get just the city name
        
        // Update coordinates in manual input fields
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lon').value = lon.toFixed(6);
        
        // Fetch weather for this location
        await selectCity(displayName, lat, lon);
        
        // Clear the search input
        //document.getElementById('citySearchInput').value = '';
        
    } catch (error) {
        console.error('City search error:', error);
        showError('Failed to find city. Please try again or use coordinates.');
    } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'üîç Search';
    }
}

async function selectCity(name, lat, lon) {
    currentCity = name;
    document.getElementById('lat').value = lat;
    document.getElementById('lon').value = lon;
    
    document.querySelectorAll('.city-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const clickedBtn = event?.target;
    if (clickedBtn?.classList.contains('city-btn')) {
        clickedBtn.classList.add('active');
    }
    
    await fetchWeather();
}

function useGeolocation() {
    if (!navigator.geolocation) {
        showError('Geolocation not supported by your browser');
        return;
    }
    
    const btn = event.target;
    btn.textContent = 'üìç Getting location...';
    btn.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            document.getElementById('lat').value = position.coords.latitude.toFixed(6);
            document.getElementById('lon').value = position.coords.longitude.toFixed(6);
            currentCity = 'Your Location';
            fetchWeather().finally(() => {
                btn.textContent = 'üìç Use My Location';
                btn.disabled = false;
            });
        },
        (error) => {
            showError('Could not get your location: ' + error.message);
            btn.textContent = 'üìç Use My Location';
            btn.disabled = false;
        }
    );
}

function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.className = 'error';
    errorDiv.textContent = message;
    setTimeout(() => {
        errorDiv.textContent = '';
        errorDiv.className = '';
    }, 5000);
}

async function fetchWeather() {
    const lat = parseFloat(document.getElementById('lat').value);
    const lon = parseFloat(document.getElementById('lon').value);
    
    if (isNaN(lat) || isNaN(lon)) {
        showError('Invalid coordinates');
        return;
    }
    
    document.getElementById('loading').style.display = 'block';
    document.getElementById('content').style.display = 'none';
    document.getElementById('error').textContent = '';
    
    try {
        const response = await fetch(
            `https://api.met.no/weatherapi/locationforecast/2.0/complete?lat=${lat}&lon=${lon}`,
            {
                headers: {
                    'User-Agent': 'WeatherDashboard/1.0 (educational)'
                }
            }
        );
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        processWeatherData(data);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        
        updateButtonStates(currentRange);
        updateRiskPanel(currentRange);
        drawCharts();
        updateDataTable();
        
    } catch (error) {
        console.error('Fetch error:', error);
        showError('Failed to fetch weather data: ' + error.message);
        document.getElementById('loading').style.display = 'none';
    }
}

function getWindDirection(degrees) {
    if (degrees === null || degrees === undefined) return '-';
    
    const directions = ['N', 'NN√ñ', 'N√ñ', '√ñN√ñ', '√ñ', '√ñS√ñ', 'S√ñ', 'SS√ñ', 'S', 'SSV', 'SV', 'VSV', 'V', 'VNV', 'NV', 'NNV'];
    const index = Math.round(degrees / 22.5) % 16;
    return directions[index];
}

function calculateFeelsLike(temp, windSpeed, humidity) {
    if (temp === null || windSpeed === null) return temp;
    
    if (temp <= 10 && windSpeed > 1.3) {
        const windKmh = windSpeed * 3.6;
        const windChill = 13.12 + 0.6215 * temp - 11.37 * Math.pow(windKmh, 0.16) + 0.3965 * temp * Math.pow(windKmh, 0.16);
        return windChill;
    }
    
    if (temp >= 27 && humidity !== null) {
        const rh = humidity;
        const heatIndex = -8.78469475556 + 
                         1.61139411 * temp + 
                         2.33854883889 * rh + 
                         -0.14611605 * temp * rh + 
                         -0.012308094 * temp * temp + 
                         -0.0164248277778 * rh * rh + 
                         0.002211732 * temp * temp * rh + 
                         0.00072546 * temp * rh * rh + 
                         -0.000003582 * temp * temp * rh * rh;
        return heatIndex;
    }
    
    return temp;
}

function processWeatherData(data) {
    const times = [];
    const temp = [], temp_p10 = [], temp_p90 = [], feels_like = [];
    const wind = [], wind_p10 = [], wind_p90 = [], gust = [], wind_direction = [];
    const precip = [], precip_p10 = [], precip_p90 = [];
    const cloud = [], humidity = [], pressure = [], uv = [];
    const symbols = []; // Store weather symbols
    
    data.properties.timeseries.forEach(entry => {
        const t = new Date(entry.time);
        const inst = entry.data.instant.details;
        const next1h = entry.data.next_1_hours;
        
        times.push(t);
        temp.push(inst.air_temperature);
        temp_p10.push(inst.air_temperature_percentile_10 || inst.air_temperature);
        temp_p90.push(inst.air_temperature_percentile_90 || inst.air_temperature);
        
        
        feels_like.push(calculateFeelsLike(inst.air_temperature, inst.wind_speed, inst.relative_humidity));
        
        wind.push(inst.wind_speed);
        wind_p10.push(inst.wind_speed_percentile_10 || inst.wind_speed);
        wind_p90.push(inst.wind_speed_percentile_90 || inst.wind_speed);
        gust.push(inst.wind_speed_of_gust || inst.wind_speed * 1.5);
        wind_direction.push(inst.wind_from_direction);
        
        // Precipitation with percentiles
        if (next1h) {
            precip.push(next1h.details.precipitation_amount);
            precip_p10.push(next1h.details.precipitation_amount_min || next1h.details.precipitation_amount);
            precip_p90.push(next1h.details.precipitation_amount_max || next1h.details.precipitation_amount);
        } else {
            precip.push(null);
            precip_p10.push(null);
            precip_p90.push(null);
        }
        
        cloud.push(inst.cloud_area_fraction);
        humidity.push(inst.relative_humidity);
        pressure.push(inst.air_pressure_at_sea_level);
        uv.push(inst.ultraviolet_index_clear_sky || 0);
        
        // Extract weather symbol
        const symbolCode = next1h?.summary?.symbol_code || 'unknown';
        symbols.push(symbolCode);
    });
    
    weatherData = {
        times,
        data: {
            temp, temp_p10, temp_p90, feels_like,
            wind, wind_p10, wind_p90, gust, wind_direction,
            precip, precip_p10, precip_p90,
            cloud, humidity, pressure, uv,
            symbols
        }
    };
    
    updateSummaryCards();
}

function getWeatherEmoji(symbolCode) {
    // Map met.no symbol codes to emojis
    const code = symbolCode.toLowerCase().replace(/_day|_night|_polartwilight/g, '');
    
    const emojiMap = {
        'clearsky': '‚òÄÔ∏è',
        'fair': 'üå§Ô∏è',
        'partlycloudy': '‚õÖ',
        'cloudy': '‚òÅÔ∏è',
        'fog': 'üå´Ô∏è',
        'lightrainshowers': 'üå¶Ô∏è',
        'rainshowers': 'üåßÔ∏è',
        'heavyrainshowers': '‚õàÔ∏è',
        'lightrain': 'üå¶Ô∏è',
        'rain': 'üåßÔ∏è',
        'heavyrain': '‚õàÔ∏è',
        'lightsleetshowers': 'üå®Ô∏è',
        'sleetshowers': 'üå®Ô∏è',
        'heavysleetshowers': 'üå®Ô∏è',
        'lightsleet': 'üå®Ô∏è',
        'sleet': 'üå®Ô∏è',
        'heavysleet': 'üå®Ô∏è',
        'lightsnowshowers': 'üå®Ô∏è',
        'snowshowers': '‚ùÑÔ∏è',
        'heavysnowshowers': '‚ùÑÔ∏è',
        'lightsnow': 'üå®Ô∏è',
        'snow': '‚ùÑÔ∏è',
        'heavysnow': '‚ùÑÔ∏è',
        'rainandthunder': '‚õàÔ∏è',
        'sleetandthunder': '‚õàÔ∏è',
        'snowandthunder': '‚õàÔ∏è',
        'lightrainandthunder': '‚õàÔ∏è',
        'lightsleetandthunder': '‚õàÔ∏è',
        'lightsnowandthunder': '‚õàÔ∏è',
        'heavyrainandthunder': '‚õàÔ∏è',
        'heavysleetandthunder': '‚õàÔ∏è',
        'heavysnowandthunder': '‚õàÔ∏è'
    };
    
    return emojiMap[code] || 'üå°Ô∏è';
}

function getWeatherDescription(symbolCode) {
    const code = symbolCode.toLowerCase().replace(/_day|_night|_polartwilight/g, '');
    
    const descMap = {
        'clearsky': 'Klart',
        'fair': 'Mest klart',
        'partlycloudy': 'Halvklart',
        'cloudy': 'Mulet',
        'fog': 'Dimma',
        'lightrainshowers': 'L√§tta regnskurar',
        'rainshowers': 'Regnskurar',
        'heavyrainshowers': 'Kraftiga regnskurar',
        'lightrain': 'Duggregn',
        'rain': 'Regn',
        'heavyrain': 'Kraftigt regn',
        'lightsleetshowers': 'L√§tta skurar sn√∂blandat regn',
        'sleetshowers': 'Skurar sn√∂blandat regn',
        'heavysleetshowers': 'Kraftiga skurar sn√∂blandat regn',
        'lightsleet': 'L√§tt sn√∂blandat regn',
        'sleet': 'Sn√∂blandat regn',
        'heavysleet': 'Kraftigt sn√∂blandat regn',
        'lightsnowshowers': 'L√§tt sn√∂fall',
        'snowshowers': 'Sn√∂fall',
        'heavysnowshowers': 'Kraftigt sn√∂fall',
        'lightsnow': 'Light Snow',
        'snow': 'Sn√∂fall',
        'heavysnow': 'Kraftigt sn√∂fall',
        'rainandthunder': '√Öska',
        'sleetandthunder': 'Sn√∂blandat & √Öska',
        'snowandthunder': 'Sn√∂ & Thunder',
        'lightrainandthunder': 'L√§tt regn & √Öska',
        'lightsleetandthunder': 'Light Sleet & Thunder',
        'lightsnowandthunder': 'Light Snow & Thunder',
        'heavyrainandthunder': 'Heavy Thunderstorm',
        'heavysleetandthunder': 'Heavy Sleet & Thunder',
        'heavysnowandthunder': 'Heavy Snow & Thunder'
    };
    
    return descMap[code] || 'Ok√§nt';
}

function updateDataTable() {
    const s = sliceData(currentRange);
    const tbody = document.getElementById('weatherDataBody');
    tbody.innerHTML = '';
    
    for (let i = 0; i < s.times.length; i++) {
        const row = tbody.insertRow();
        
        // Time
        const timeCell = row.insertCell();
        const timeStr = s.times[i].toLocaleString('en-GB', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        timeCell.textContent = timeStr;
        
        // Weather Condition
        const conditionCell = row.insertCell();
        const symbolCode = s.data.symbols[i];
        const emoji = getWeatherEmoji(symbolCode);
        const description = getWeatherDescription(symbolCode);
        conditionCell.innerHTML = `<div class="weather-symbol"><span class="weather-icon">${emoji}</span><span>${description}</span></div>`;
        
        // Temperature with percentiles
        const tempVal = s.data.temp[i];
        const tempP10 = s.data.temp_p10[i];
        const tempP90 = s.data.temp_p90[i];
        if (tempVal !== null && tempVal !== undefined) {
            row.insertCell().textContent = `${tempVal.toFixed(1)} (${tempP10.toFixed(1)} <‚Äì> ${tempP90.toFixed(1)})`;
        } else {
            row.insertCell().textContent = '-';
        }
        
        // Feels Like - ensure proper number formatting with sign
        const feelsVal = s.data.feels_like[i];
        if (feelsVal !== null && feelsVal !== undefined) {
            row.insertCell().textContent = feelsVal.toFixed(1);
        } else {
            row.insertCell().textContent = '-';
        }
        
        // Wind
        row.insertCell().textContent = s.data.wind[i]?.toFixed(1) || '-';
        
        // Wind Direction
        const windDir = s.data.wind_direction[i];
        row.insertCell().textContent = getWindDirection(windDir);
        
        // Gust
        row.insertCell().textContent = s.data.gust[i]?.toFixed(1) || '-';
        
        // Precipitation with percentiles
        const precipVal = s.data.precip[i];
        const precipP10 = s.data.precip_p10[i];
        const precipP90 = s.data.precip_p90[i];
        if (precipVal !== null && precipVal !== undefined) {
            row.insertCell().textContent = `${precipVal.toFixed(1)} (${precipP10.toFixed(1)} ‚Äì ${precipP90.toFixed(1)})`;
        } else {
            row.insertCell().textContent = '-';
        }
        
        // Cloud
        row.insertCell().textContent = s.data.cloud[i]?.toFixed(0) || '-';
        
        // Humidity
        row.insertCell().textContent = s.data.humidity[i]?.toFixed(0) || '-';
        
        // Pressure
        row.insertCell().textContent = s.data.pressure[i]?.toFixed(1) || '-';
        
        // UV
        row.insertCell().textContent = s.data.uv[i]?.toFixed(1) || '-';
    }
}

function updateSummaryCards() {
    const current = weatherData.data;
    
    document.getElementById('cloudValue').textContent = `${current.cloud[0]?.toFixed(0) || '-'}%`;
    document.getElementById('cloudRange').textContent = 
        `${Math.min(...current.cloud).toFixed(0)}% - ${Math.max(...current.cloud).toFixed(0)}%`;
    
    document.getElementById('humidityValue').textContent = `${current.humidity[0]?.toFixed(0) || '-'}%`;
    document.getElementById('humidityRange').textContent = 
        `${Math.min(...current.humidity).toFixed(0)}% - ${Math.max(...current.humidity).toFixed(0)}%`;
    
    document.getElementById('pressureValue').textContent = `${current.pressure[0]?.toFixed(0) || '-'} hPa`;
    document.getElementById('pressureRange').textContent = 
        `${Math.min(...current.pressure).toFixed(0)} - ${Math.max(...current.pressure).toFixed(0)} hPa`;
    
    document.getElementById('uvValue').textContent = current.uv[0]?.toFixed(1) || '-';
    document.getElementById('uvRange').textContent = 
        `Max: ${Math.max(...current.uv).toFixed(1)}`;
}

function updateRiskPanel(hours) {
    const s = sliceData(hours);
    const panel = document.getElementById('riskPanel');
    
    const maxTemp = Math.max(...s.data.temp);
    const minTemp = Math.min(...s.data.temp);
    const maxWind = Math.max(...s.data.wind);
    const maxGust = Math.max(...s.data.gust);
    const maxUV = Math.max(...s.data.uv);
    const totalPrecip = s.data.precip.reduce((a, b) => a + (b || 0), 0);
    
    let tempClass = maxTemp > 30 || minTemp < -10 ? 'high' : maxTemp > 25 || minTemp < 0 ? 'medium' : 'low';
    let windClass = maxWind > 15 ? 'high' : maxWind > 10 ? 'medium' : 'low';
    let gustClass = maxGust > 20 ? 'high' : maxGust > 15 ? 'medium' : 'low';
    let uvClass = maxUV > 7 ? 'high' : maxUV > 3 ? 'medium' : 'low';
    let precipClass = totalPrecip > 10 ? 'high' : totalPrecip > 2 ? 'medium' : 'low';
    
    const hoursLabel = hours === 9999 ? 'All Data' : `Kommande ${hours}h`;
    
    panel.innerHTML = `
        <h2> Sammanfattning - ${hoursLabel}</h2>
        <div class="risk-grid">
            <div class="risk-item ${tempClass}">
                <div class="risk-label">
                    <span class="risk-icon">üå°Ô∏è</span>
                    <span>Temperatur</span>
                </div>
                <div class="risk-time">${minTemp.toFixed(1)}¬∞C till ${maxTemp.toFixed(1)}¬∞C</div>
            </div>
            <div class="risk-item ${windClass}">
                <div class="risk-label">
                    <span class="risk-icon">üí®</span>
                    <span>Vindhastighet</span>
                </div>
                <div class="risk-time">Max: ${maxWind.toFixed(1)} m/s</div>
            </div>
            <div class="risk-item ${gustClass}">
                <div class="risk-label">
                    <span class="risk-icon">üå™Ô∏è</span>
                    <span>Vindbyar</span>
                </div>
                <div class="risk-time">Max: ${maxGust.toFixed(1)} m/s</div>
            </div>
            <div class="risk-item ${uvClass}">
                <div class="risk-label">
                    <span class="risk-icon">‚òÄÔ∏è</span>
                    <span>UV Index</span>
                </div>
                <div class="risk-time">Max: ${maxUV.toFixed(1)}</div>
            </div>
            <div class="risk-item ${precipClass}">
                <div class="risk-label">
                    <span class="risk-icon">üåßÔ∏è</span>
                    <span>Nederb√∂rd</span>
                </div>
                <div class="risk-time">Total: ${totalPrecip.toFixed(1)} mm</div>
            </div>
        </div>
    `;
}

function sliceData(hours) {
    const maxPoints = hours === 9999 ? weatherData.times.length : 
        Math.min(weatherData.times.length, hours);
    
    return {
        times: weatherData.times.slice(0, maxPoints),
        data: Object.fromEntries(
            Object.entries(weatherData.data).map(([k, v]) => [k, v.slice(0, maxPoints)])
        )
    };
}

function updateButtonStates(hours) {
    document.querySelectorAll('.controls button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const btnId = hours === 9999 ? 'btn-all' : `btn-${hours}`;
    const btn = document.getElementById(btnId);
    if (btn) btn.classList.add('active');
}

function drawCharts() {
    const s = sliceData(currentRange);
    
    const config = {
        responsive: true,
        displayModeBar: false,
        scrollZoom: false,
        doubleClick: false,
        dragMode: false,
        staticPlot: false,
        modeBarButtonsToRemove: ['zoom2d', 'pan2d', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d']
    };
    
    // Temperature Chart
    const currentTemp = s.data.temp[0];
    const currentFeelsLike = s.data.feels_like[0];
    
    Plotly.newPlot('tempChart', [
        {
            x: s.times,
            y: s.data.temp_p10,
            type: 'scatter',
            mode: 'lines',
            line: { width: 0 },
            showlegend: false,
            fill: 'none',
            hoverinfo: 'skip'
        },
        {
            x: s.times,
            y: s.data.temp_p90,
            type: 'scatter',
            mode: 'lines',
            fill: 'tonexty',
            fillcolor: 'rgba(59, 130, 246, 0.15)',
            line: { width: 1, color: 'rgba(59, 130, 246, 0.3)' },
            name: 'P10-P90',
            hovertemplate: 'P90: %{y:.1f}¬∞C<extra></extra>'
        },
        {
            x: s.times,
            y: s.data.temp_p10,
            type: 'scatter',
            mode: 'lines',
            line: { width: 1, color: 'rgba(59, 130, 246, 0.3)' },
            name: 'P10',
            hovertemplate: 'P10: %{y:.1f}¬∞C<extra></extra>'
        },
        {
            x: s.times,
            y: s.data.temp,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#3b82f6', width: 3 },
            name: 'Temp',
            hovertemplate: 'Temp: %{y:.1f}¬∞C<extra></extra>'
        },
        {
            x: s.times,
            y: s.data.feels_like,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#8b5cf6', width: 2, dash: 'dot' },
            name: 'K√§nns som',
            hovertemplate: 'K√§nns som: %{y:.1f}¬∞C<extra></extra>'
        }
    ], {
        margin: { t: 50, r: 20, b: 40, l: 45 },
        height: 280,
        autosize: true,
        hovermode: 'x unified',
        plot_bgcolor: '#f8fafc',
        paper_bgcolor: 'white',
        font: { family: 'system-ui', size: 11 },
        title: { 
            text: `üå°Ô∏è ${currentTemp?.toFixed(1) || 'N/A'}¬∞C (k√§nns som ${currentFeelsLike?.toFixed(1) || 'N/A'}¬∞C)`, 
            font: { size: 14, color: '#1e293b' },
            x: 0.05,
            xanchor: 'left'
        },
        xaxis: {
            gridcolor: '#e2e8f0',
            linecolor: '#cbd5e1',
            fixedrange: true
        },
        yaxis: {
            title: { text: '¬∞C', font: { size: 11 } },
            gridcolor: '#e2e8f0',
            linecolor: '#cbd5e1',
            fixedrange: true
        },
        legend: {
            orientation: 'h',
            y: -0.15,
            x: 0.5,
            xanchor: 'center',
            font: { size: 10 }
        },
        dragmode: false
    }, config);
    
    // Wind Chart
    const currentWind = s.data.wind[0];
    const currentGust = s.data.gust[0];
    const currentWindDir = s.data.wind_direction[0];
    
    // Create annotations for wind direction arrows (show every 3rd point to avoid clutter)
    const windAnnotations = [];
    const showEveryN = Math.max(1, Math.floor(s.times.length / 12)); // Show max 12 arrows
    for (let i = 0; i < s.times.length; i += showEveryN) {
        if (s.data.wind_direction[i] !== null && s.data.wind[i] > 0.5) {
            // Convert wind direction to arrow rotation (wind blows FROM direction, arrow points TO)
            const arrowRotation = (s.data.wind_direction[i]) % 360;
            windAnnotations.push({
                x: s.times[i],
                y: s.data.wind[i],
                text: '‚Üì',
                showarrow: false,
                font: { size: 28, color: '#222423' },
                textangle: arrowRotation,
                xanchor: 'center',
                yanchor: 'middle'
            });
        }
    }
    
    Plotly.newPlot('windChart', [
        {
            x: s.times,
            y: s.data.wind_p10,
            type: 'scatter',
            mode: 'lines',
            line: { width: 0 },
            showlegend: false,
            fill: 'none',
            hoverinfo: 'skip'
        },
        {
            x: s.times,
            y: s.data.wind_p90,
            type: 'scatter',
            mode: 'lines',
            fill: 'tonexty',
            fillcolor: 'rgba(16, 185, 129, 0.15)',
            line: { width: 1, color: 'rgba(16, 185, 129, 0.3)' },
            name: 'P10-P90',
            hovertemplate: 'P90: %{y:.1f} m/s<extra></extra>'
        },
        {
            x: s.times,
            y: s.data.wind_p10,
            type: 'scatter',
            mode: 'lines',
            line: { width: 1, color: 'rgba(16, 185, 129, 0.3)' },
            name: 'P10',
            hovertemplate: 'P10: %{y:.1f} m/s<extra></extra>'
        },
        {
            x: s.times,
            y: s.data.wind,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#10b981', width: 3 },
            name: 'Medelvind',
            hovertemplate: 'Medelvind: %{y:.1f} m/s<extra></extra>'
        },
        {
            x: s.times,
            y: s.data.gust,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#f59e0b', width: 2, dash: 'dash' },
            name: 'Vindbyar',
            hovertemplate: 'Vindbyar: %{y:.1f} m/s<extra></extra>'
        }
    ], {
        margin: { t: 50, r: 20, b: 40, l: 45 },
        height: 280,
        autosize: true,
        hovermode: 'x unified',
        plot_bgcolor: '#f8fafc',
        paper_bgcolor: 'white',
        font: { family: 'system-ui', size: 11 },
        title: { 
            text: `üí® ${currentWind?.toFixed(1) || 'N/A'} m/s (byar ${currentGust?.toFixed(1) || 'N/A'} m/s) ${getWindDirection(currentWindDir)}`, 
            font: { size: 14, color: '#1e293b' },
            x: 0.05,
            xanchor: 'left'
        },
        xaxis: {
            gridcolor: '#e2e8f0',
            linecolor: '#cbd5e1',
            fixedrange: true
        },
        yaxis: {
            title: { text: 'm/s', font: { size: 11 } },
            gridcolor: '#e2e8f0',
            linecolor: '#cbd5e1',
            fixedrange: true
        },
        legend: {
            orientation: 'h',
            y: -0.15,
            x: 0.5,
            xanchor: 'center',
            font: { size: 10 }
        },
        annotations: windAnnotations,
        dragmode: false
    }, config);
    
    // Precipitation Chart
    const currentPrecip = s.data.precip[0];
    const validPrecipData = s.times.map((time, i) => ({
        time: time,
        precip: s.data.precip[i] !== null ? s.data.precip[i] : 0,
        precip_p10: s.data.precip_p10[i] !== null ? s.data.precip_p10[i] : 0,
        precip_p90: s.data.precip_p90[i] !== null ? s.data.precip_p90[i] : 0
    }));
    
    Plotly.newPlot('precipChart', [
        {
            x: validPrecipData.map(d => d.time),
            y: validPrecipData.map(d => d.precip_p10),
            type: 'scatter',
            mode: 'lines',
            line: { width: 0 },
            showlegend: false,
            fill: 'none',
            hoverinfo: 'skip'
        },
        {
            x: validPrecipData.map(d => d.time),
            y: validPrecipData.map(d => d.precip_p90),
            type: 'scatter',
            mode: 'lines',
            fill: 'tonexty',
            fillcolor: 'rgba(6, 182, 212, 0.15)',
            line: { width: 1, color: 'rgba(6, 182, 212, 0.3)' },
            name: 'Min-Max',
            hovertemplate: 'Max: %{y:.1f} mm<extra></extra>'
        },
        {
            x: validPrecipData.map(d => d.time),
            y: validPrecipData.map(d => d.precip_p10),
            type: 'scatter',
            mode: 'lines',
            line: { width: 1, color: 'rgba(6, 182, 212, 0.3)' },
            name: 'Min',
            hovertemplate: 'Min: %{y:.1f} mm<extra></extra>'
        },
        {
            x: validPrecipData.map(d => d.time),
            y: validPrecipData.map(d => d.precip),
            type: 'scatter',
            mode: 'lines',
            line: { color: '#06b6d4', width: 3 },
            name: 'Nederb√∂rd',
            hovertemplate: 'Precip: %{y:.1f} mm<extra></extra>'
        }
    ], {
        margin: { t: 50, r: 20, b: 40, l: 45 },
        height: 280,
        autosize: true,
        hovermode: 'x unified',
        plot_bgcolor: '#f8fafc',
        paper_bgcolor: 'white',
        font: { family: 'system-ui', size: 11 },
        title: { 
            text: `üåßÔ∏è ${currentPrecip?.toFixed(1) || '0.0'} mm`, 
            font: { size: 14, color: '#1e293b' },
            x: 0.05,
            xanchor: 'left'
        },
        xaxis: {
            gridcolor: '#e2e8f0',
            linecolor: '#cbd5e1',
            fixedrange: true
        },
        yaxis: {
            title: { text: 'mm', font: { size: 11 } },
            gridcolor: '#e2e8f0',
            linecolor: '#cbd5e1',
            fixedrange: true
        },
        legend: {
            orientation: 'h',
            y: -0.15,
            x: 0.5,
            xanchor: 'center',
            font: { size: 10 }
        },
        dragmode: false
    }, config);
    
    // Sparklines
    const sparkConfig = { 
        displayModeBar: false,
        staticPlot: false,
        responsive: true
    };
    const sparkHours = Math.min(24, currentRange === 9999 ? 48 : currentRange);
    const sparkLayout = {
        margin: { t: 5, r: 5, b: 5, l: 5 },
        xaxis: { visible: false, fixedrange: true },
        yaxis: { visible: false, fixedrange: true },
        showlegend: false,
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        height: 60,
        width: null,
        autosize: true,
        hovermode: 'closest',
        dragmode: false
    };
    
    Plotly.newPlot('cloudSpark', [{
        x: s.times.slice(0, sparkHours),
        y: s.data.cloud.slice(0, sparkHours),
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: '#94a3b8', width: 2 },
        hovertemplate: '%{x|%b %d %H:%M}<br>%{y:.1f}%<extra></extra>'
    }], {...sparkLayout}, sparkConfig);
    
    Plotly.newPlot('humiditySpark', [{
        x: s.times.slice(0, sparkHours),
        y: s.data.humidity.slice(0, sparkHours),
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: '#94a3b8', width: 2 },
        hovertemplate: '%{x|%b %d %H:%M}<br>%{y:.1f}%<extra></extra>'
    }], {...sparkLayout}, sparkConfig);
    
    Plotly.newPlot('pressureSpark', [{
        x: s.times.slice(0, sparkHours),
        y: s.data.pressure.slice(0, sparkHours),
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: '#94a3b8', width: 2 },
        hovertemplate: '%{x|%b %d %H:%M}<br>%{y:.1f} hPa<extra></extra>'
    }], {...sparkLayout}, sparkConfig);
    
    Plotly.newPlot('uvSpark', [{
        x: s.times.slice(0, sparkHours),
        y: s.data.uv.slice(0, sparkHours),
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: '#94a3b8', width: 2 },
        hovertemplate: '%{x|%b %d %H:%M}<br>%{y:.1f}<extra></extra>'
    }], {...sparkLayout}, sparkConfig);
}

function setRange(hours) {
    currentRange = hours;
    updateButtonStates(hours);
    updateRiskPanel(hours);
    drawCharts();
    updateDataTable();
}

// Load default location on page load
window.addEventListener('load', () => {
    selectCity('Skellefte√•', 64.762519, 20.923440);
});

</script>
</body>
</html>
