<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#090e1a">
<title>Eriks vÃ¤derapp</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Manrope:wght@500;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg:        #090e1a;
  --surface:   #111827;
  --surface2:  #1a2438;
  --border:    #1f2e47;
  --muted:     #4a6080;
  --text:      #e2eaf7;
  --text-dim:  #7a94b8;
  --accent:    #38bdf8;
  --green:     #34d399;
  --amber:     #fbbf24;
  --red:       #f87171;
  --purple:    #a78bfa;
  --cyan:      #67e8f9;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€ HEADER â”€â”€ */
.header {
  padding: 20px 20px 0;
  display: flex;
  align-items: baseline;
  gap: 14px;
  flex-wrap: wrap;
}

.header-title {
  font-family: 'Manrope', sans-serif;
  font-size: 1.8rem;
  font-weight: 800;
  letter-spacing: -0.03em;
  color: var(--text);
  line-height: 1;
}

.header-title span { color: var(--accent); }

.header-sub {
  font-size: 0.72rem;
  color: var(--muted);
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

/* â”€â”€ MAIN GRID â”€â”€ */
.app { padding: 16px 16px 32px; display: flex; flex-direction: column; gap: 12px; max-width: 1200px; margin: 0 auto; }

/* â”€â”€ CONTROL BAR â”€â”€ */
.control-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.location-pill {
  display: flex;
  align-items: center;
  gap: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  flex: 1;
  min-width: 240px;
}

.location-pill input {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text);
  font-family: 'Inter', sans-serif;
  font-size: 0.85rem;
  padding: 9px 12px;
  outline: none;
}

.location-pill input::placeholder { color: var(--muted); }

.pill-btn {
  background: transparent;
  border: none;
  border-left: 1px solid var(--border);
  color: var(--accent);
  font-family: 'Inter', sans-serif;
  font-size: 0.82rem;
  padding: 9px 12px;
  cursor: pointer;
  white-space: nowrap;
  transition: background 0.15s;
}
.pill-btn:hover { background: var(--surface2); }
.pill-btn:active { background: var(--border); }

.preset-strip {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.preset-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-dim);
  font-family: 'Inter', sans-serif;
  font-size: 0.8rem;
  padding: 7px 12px;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.preset-btn:hover { border-color: var(--accent); color: var(--accent); }
.preset-btn.active { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 600; }

/* Coord toggle */
.coord-row {
  display: none;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
.coord-row.visible { display: flex; }
.coord-label { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.04em; font-weight: 500; }
.coord-input {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: 'Inter', sans-serif;
  font-size: 0.82rem;
  padding: 7px 10px;
  width: 130px;
  outline: none;
}
.coord-input:focus { border-color: var(--accent); }

.action-strip {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
}

.fetch-btn {
  background: var(--accent);
  border: none;
  border-radius: 6px;
  color: #000;
  font-family: 'Inter', sans-serif;
  font-size: 0.82rem;
  font-weight: 600;
  padding: 9px 16px;
  cursor: pointer;
  transition: all 0.15s;
  touch-action: manipulation;
  min-height: 38px;
}
.fetch-btn:hover { background: #7dd3fc; }
.fetch-btn:disabled { background: var(--muted); cursor: not-allowed; }

.geo-btn {
  background: transparent;
  border: 1px solid var(--green);
  border-radius: 6px;
  color: var(--green);
  font-family: 'Inter', sans-serif;
  font-size: 0.82rem;
  font-weight: 500;
  padding: 9px 16px;
  cursor: pointer;
  transition: all 0.15s;
  touch-action: manipulation;
  min-height: 38px;
  white-space: nowrap;
}
.geo-btn:hover { background: rgba(52,211,153,0.08); }
.geo-btn:active { background: rgba(52,211,153,0.15); }

.coord-toggle-btn {
  background: transparent;
  border: 1px dashed var(--border);
  border-radius: 6px;
  color: var(--muted);
  font-family: 'Inter', sans-serif;
  font-size: 0.78rem;
  padding: 7px 12px;
  cursor: pointer;
  transition: border-color 0.15s;
  touch-action: manipulation;
}
.coord-toggle-btn:hover { border-color: var(--muted); color: var(--text-dim); }

/* â”€â”€ RANGE TABS â”€â”€ */
.range-tabs {
  display: flex;
  gap: 4px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px;
  width: fit-content;
}

.range-tab {
  background: transparent;
  border: none;
  border-radius: 5px;
  color: var(--text-dim);
  font-family: 'Inter', sans-serif;
  font-size: 0.78rem;
  font-weight: 500;
  padding: 7px 14px;
  cursor: pointer;
  transition: all 0.15s;
  touch-action: manipulation;
  min-height: 34px;
}
.range-tab:hover { color: var(--text); }
.range-tab.active { background: var(--surface2); color: var(--accent); border: 1px solid var(--border); }

/* â”€â”€ CURRENT CONDITIONS ROW â”€â”€ */
.current-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 8px;
}

.current-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px 14px 10px;
  position: relative;
  overflow: hidden;
}

.current-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: var(--card-color, var(--accent));
}

.current-card-label {
  font-size: 0.68rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 6px;
  font-weight: 500;
}

.current-card-value {
  font-family: 'Manrope', sans-serif;
  font-size: 1.55rem;
  font-weight: 800;
  line-height: 1;
  color: var(--card-color, var(--text));
  margin-bottom: 4px;
}

.current-card-sub {
  font-size: 0.75rem;
  color: var(--text-dim);
  line-height: 1.4;
  font-weight: 400;
}

.current-card-spark {
  margin-top: 8px;
  height: 40px;
}

/* â”€â”€ SUMMARY STATS ROW â”€â”€ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 8px;
}

.stat-block {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.stat-label {
  font-size: 0.62rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
}

.stat-value {
  font-family: 'Manrope', sans-serif;
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--text);
}

.stat-range {
  font-size: 0.65rem;
  color: var(--text-dim);
}

/* â”€â”€ RISK BADGES ROW â”€â”€ */
.risk-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.risk-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 100px;
  font-size: 0.72rem;
  border: 1px solid;
}

.risk-badge.low  { border-color: var(--green);  color: var(--green);  background: rgba(52,211,153,0.07); }
.risk-badge.medium { border-color: var(--amber); color: var(--amber); background: rgba(251,191,36,0.07); }
.risk-badge.high { border-color: var(--red);   color: var(--red);   background: rgba(248,113,113,0.07); }

.risk-badge-icon { font-size: 0.9rem; }
.risk-section-label {
  font-size: 0.65rem;
  color: var(--muted);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  align-self: center;
  white-space: nowrap;
}

/* â”€â”€ CHART PANEL â”€â”€ */
.chart-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  touch-action: pan-x pan-y;
}

.chart-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
}

.chart-panel-title {
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
}

.chart-panel-live {
  font-family: 'Manrope', sans-serif;
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--text);
}

/* â”€â”€ TIMELINE TABLE â”€â”€ */
.timeline-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}

.timeline-header {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
}

.timeline-scroll {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.timeline-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
  white-space: nowrap;
}

.timeline-table th {
  background: var(--surface2);
  color: var(--muted);
  padding: 8px 10px;
  text-align: left;
  font-weight: 400;
  font-size: 0.65rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
}

.timeline-table td {
  padding: 8px 10px;
  border-bottom: 1px solid rgba(31,46,71,0.5);
  color: var(--text-dim);
  font-size: 0.73rem;
}

.timeline-table td.highlight {
  color: var(--text);
  font-weight: 500;
}

.timeline-table tr:hover td {
  background: rgba(56,189,248,0.04);
  color: var(--text);
}

.timeline-table tr:last-child td { border-bottom: none; }

.time-cell {
  color: var(--text-dim) !important;
  font-size: 0.68rem !important;
}

/* â”€â”€ STICKY TIME COLUMN â”€â”€ */
.timeline-table th:first-child,
.timeline-table td:first-child {
  position: sticky;
  left: 0;
  background: var(--surface);
  z-index: 1;
  border-right: 1px solid var(--border);
}

.timeline-table th:first-child {
  background: var(--surface2);
  z-index: 2;
}

.cond-cell {
  display: flex;
  align-items: center;
  gap: 5px;
  min-width: 130px;
}

.temp-hot  { color: var(--red) !important; }
.temp-cold { color: var(--cyan) !important; }
.temp-norm { color: var(--text) !important; }

.wind-high { color: var(--red) !important; }
.wind-med  { color: var(--amber) !important; }

.precip-wet { color: var(--accent) !important; }

/* â”€â”€ ERRORS & LOADING â”€â”€ */
.error-box {
  background: rgba(248,113,113,0.1);
  border: 1px solid var(--red);
  border-radius: 8px;
  padding: 10px 14px;
  color: var(--red);
  font-size: 0.8rem;
}


.loading-box {
  text-align: center;
  padding: 40px;
  color: var(--muted);
  font-size: 0.85rem;
  letter-spacing: 0.1em;
}

.loading-box::after {
  content: '';
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
  margin-left: 8px;
  animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.2; transform: scale(0.8); }
  50% { opacity: 1; transform: scale(1); }
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}

.blink {
  animation: blink 1.5s ease-in-out infinite;
  color: var(--accent);
  font-size: 0.9em;
  display: inline-block;
}

/* â”€â”€ SECTION DIVIDER â”€â”€ */
.section-title {
  font-size: 0.62rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--muted);
  padding-top: 4px;
}

@media (max-width: 480px) {
  .header-title { font-size: 1.4rem; }
  .current-card-value { font-size: 1.25rem; }
  .range-tab { padding: 6px 10px; font-size: 0.75rem; }
  .current-row { grid-template-columns: repeat(2, 1fr); }
  .location-pill { min-width: 0; }
  .preset-strip { gap: 5px; }
  .preset-btn { font-size: 0.75rem; padding: 6px 9px; }
  .risk-badge { font-size: 0.68rem; padding: 5px 10px; }
  .app { padding: 12px 12px 32px; gap: 10px; }
}

@media (max-width: 360px) {
  .range-tab { padding: 6px 7px; font-size: 0.7rem; }
  .current-card-value { font-size: 1.1rem; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">ğŸŒ¤ Eriks <span>vÃ¤derapp</span></div>
  <div class="header-sub">Detaljerade vÃ¤derprognoser</div>
</div>

<div class="app">

  <!-- LOCATION SEARCH -->
  <div style="display:flex; flex-direction:column; gap:8px;">
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <div class="location-pill">
        <input type="text" id="citySearchInput" placeholder="SÃ¶k plats... (plats, kommun, lÃ¤n, postnr, land)" onkeypress="if(event.key==='Enter') searchCity()">
        <button class="pill-btn" onclick="searchCity()">ğŸ” SÃ¶k</button>
      </div>
      <button class="geo-btn" onclick="useGeolocation()">ğŸ“ Min plats</button>
    </div>

    <div class="preset-strip">
      <button class="preset-btn" onclick="selectCity('SkellefteÃ¥',64.762519,20.923440)">SkellefteÃ¥</button>
      <button class="preset-btn" onclick="selectCity('Stockholm',59.3293,18.0686)">Stockholm</button>
      <button class="preset-btn" onclick="selectCity('Skarja, Sarek',67.377503,17.644642)">Skarja, Sarek</button>
      <button class="preset-btn" onclick="selectCity('Sjungande dalen',64.762528,20.923429)">Sjungande dalen</button>
      <button class="preset-btn" onclick="selectCity('Longyearbyen',78.224083,15.62873)">Longyearbyen</button>
      <button class="coord-toggle-btn" onclick="toggleCoords()">âš™ Koordinater</button>
    </div>

    <div id="coordRow" class="coord-row">
      <span class="coord-label">LAT</span>
      <input type="number" id="lat" class="coord-input" step="0.0001" value="64.762519">
      <span class="coord-label">LON</span>
      <input type="number" id="lon" class="coord-input" step="0.0001" value="20.923440">
      <button class="fetch-btn" onclick="fetchWeather()">ğŸ“¡ HÃ¤mta</button>
    </div>
  </div>

  <!-- ERROR -->
  <div id="error" style="display:none;" class="error-box"></div>

  <!-- LOADING -->
  <div id="loading" class="loading-box" style="display:none;">Laddar vÃ¤derdata</div>

  <!-- CONTENT -->
  <div id="content" style="display:none; display:flex; flex-direction:column; gap:12px;">

    <!-- RANGE TABS -->
    <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px;">
      <div class="range-tabs">
        <button class="range-tab" id="btn-6"   onclick="setRange(6)">6h</button>
        <button class="range-tab" id="btn-12"  onclick="setRange(12)">12h</button>
        <button class="range-tab" id="btn-24"  onclick="setRange(24)">24h</button>
        <button class="range-tab" id="btn-48"  onclick="setRange(48)">48h</button>
        <button class="range-tab" id="btn-all" onclick="setRange(9999)">Samtliga</button>
        <input type="number" id="customHours" class="range-tab" style="width:90px; text-align:center; padding:7px 4px;" 
         placeholder="enter h..." min="1" step="1" 
         onkeypress="if(event.key==='Enter') setRange(parseInt(this.value))" 
         onblur="if(this.value) setRange(parseInt(this.value))">
      </div>
      <div id="locationLabel" class="header-sub"></div>
    </div>

    <!-- RISK BADGES -->
    <div>
      <div class="section-title" style="margin-bottom:6px;">Sammanfattning</div>
      <div id="riskRow" class="risk-row"></div>
    </div>

    <!-- CURRENT CONDITION CARDS (with sparklines) -->
    <div>
      <div class="section-title" style="margin-bottom:6px;">Under perioden</div>
      <div class="current-row">
        <div class="current-card" style="--card-color:var(--accent)">
          <div class="current-card-label">MedelTemperatur</div>
          <div class="current-card-value" id="cTemp">â€”</div>
          <div class="current-card-sub" id="cTempRange">â€”</div>
          <div class="current-card-spark" id="sparkTemp"></div>
        </div>
        <div class="current-card" style="--card-color:var(--green)">
          <div class="current-card-label">Medelvind</div>
          <div class="current-card-value" id="cWind">â€”</div>
          <div class="current-card-sub" id="cWindsub">â€”</div>
          <div class="current-card-spark" id="sparkWind"></div>
        </div>
        <div class="current-card" style="--card-color:var(--cyan)">
          <div class="current-card-label">MedelNederbÃ¶rd</div>
          <div class="current-card-value" id="cPrecip">â€”</div>
          <div class="current-card-sub" id="cPrecipSub">â€”</div>
          <div class="current-card-spark" id="sparkPrecip"></div>
        </div>
        <div class="current-card" style="--card-color:var(--muted)">
          <div class="current-card-label">MedelMolntÃ¤cke</div>
          <div class="current-card-value" id="cCloud">â€”</div>
          <div class="current-card-sub" id="cCloudRange">â€”</div>
          <div class="current-card-spark" id="sparkCloud"></div>
        </div>
        <div class="current-card" style="--card-color:var(--purple)">
          <div class="current-card-label">MedelLuftfuktighet</div>
          <div class="current-card-value" id="cHumidity">â€”</div>
          <div class="current-card-sub" id="cHumidityRange">â€”</div>
          <div class="current-card-spark" id="sparkHumidity"></div>
        </div>
        <div class="current-card" style="--card-color:var(--amber)">
          <div class="current-card-label">MedelLufttryck</div>
          <div class="current-card-value" id="cPressure">â€”</div>
          <div class="current-card-sub" id="cPressureRange">â€”</div>
          <div class="current-card-spark" id="sparkPressure"></div>
        </div>
        <div class="current-card" style="--card-color:#f97316">
          <div class="current-card-label">Medel UV Index</div>
          <div class="current-card-value" id="cUV">â€”</div>
          <div class="current-card-sub" id="cUVRange">â€”</div>
          <div class="current-card-spark" id="sparkUV"></div>
        </div>
      </div>
    </div>

    <!-- CHARTS STACKED -->
    <div>
      <div class="section-title" style="margin-bottom:6px;">Grafer</div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="chart-panel">
          <div class="chart-panel-header">
            <span class="chart-panel-title">Temperatur</span>
            <span class="chart-panel-live" id="chartTempLive"></span>
          </div>
          <div id="tempChart"></div>
        </div>
        <div class="chart-panel">
          <div class="chart-panel-header">
            <span class="chart-panel-title">Vind</span>
            <span class="chart-panel-live" id="chartWindLive"></span>
          </div>
          <div id="windChart"></div>
        </div>
        <div class="chart-panel">
          <div class="chart-panel-header">
            <span class="chart-panel-title">NederbÃ¶rd</span>
            <span class="chart-panel-live" id="chartPrecipLive"></span>
          </div>
          <div id="precipChart"></div>
        </div>
      </div>
    </div>

    <!-- TIMELINE TABLE -->
    <div>
      <div class="section-title" style="margin-bottom:6px;">Detaljer</div>
      <div class="timeline-section">
        <div class="timeline-scroll">
          <table class="timeline-table" id="weatherDataTable">
            <thead>
              <tr>
                <th>Tid</th>
                <th>VÃ¤der</th>
                <th>Temp (Â°C)</th>
                <th>KÃ¤nns (Â°C)</th>
                <th>Vind (m/s)</th>
                <th>Nederb (mm)</th>
                <th>Moln (%)</th>
                <th>Luftfukt. (%)</th>
                <th>Tryck (hPa)</th>
                <th>UV</th>
              </tr>
            </thead>
            <tbody id="weatherDataBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /app -->

<script>
let weatherData = null;
let currentRange = 24;
let currentCity = 'SkellefteÃ¥';

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function toggleCoords() {
  document.getElementById('coordRow').classList.toggle('visible');
}

function showError(msg) {
  const el = document.getElementById('error');
  el.style.display = 'block';
  el.textContent = msg;
  setTimeout(() => { el.style.display = 'none'; }, 5000);
}

function getWindDirection(degrees) {
  if (degrees === null || degrees === undefined) return 'â€”';
  const dirs = ['N','NNÃ–','NÃ–','Ã–NÃ–','Ã–','Ã–SÃ–','SÃ–','SSÃ–','S','SSV','SV','VSV','V','VNV','NV','NNV'];
  return dirs[Math.round(degrees / 22.5) % 16];
}

function calculateFeelsLike(temp, windSpeed, humidity) {
  if (temp === null || windSpeed === null) return temp;
  if (temp <= 10 && windSpeed > 1.3) {
    const wk = windSpeed * 3.6;
    return 13.12 + 0.6215*temp - 11.37*Math.pow(wk,0.16) + 0.3965*temp*Math.pow(wk,0.16);
  }
  if (temp >= 27 && humidity !== null) {
    const rh = humidity;
    return -8.78469475556 + 1.61139411*temp + 2.33854883889*rh
      - 0.14611605*temp*rh - 0.012308094*temp*temp
      - 0.0164248277778*rh*rh + 0.002211732*temp*temp*rh
      + 0.00072546*temp*rh*rh - 0.000003582*temp*temp*rh*rh;
  }
  return temp;
}

function getWeatherEmoji(symbolCode) {
  const code = symbolCode.toLowerCase().replace(/_day|_night|_polartwilight/g,'');
  const map = {
    clearsky:'â˜€ï¸', fair:'ğŸŒ¤ï¸', partlycloudy:'â›…', cloudy:'â˜ï¸', fog:'ğŸŒ«ï¸',
    lightrainshowers:'ğŸŒ¦ï¸', rainshowers:'ğŸŒ§ï¸', heavyrainshowers:'â›ˆï¸',
    lightrain:'ğŸŒ¦ï¸', rain:'ğŸŒ§ï¸', heavyrain:'â›ˆï¸',
    lightsleetshowers:'ğŸŒ¨ï¸', sleetshowers:'ğŸŒ¨ï¸', heavysleetshowers:'ğŸŒ¨ï¸',
    lightsleet:'ğŸŒ¨ï¸', sleet:'ğŸŒ¨ï¸', heavysleet:'ğŸŒ¨ï¸',
    lightsnowshowers:'ğŸŒ¨ï¸', snowshowers:'â„ï¸', heavysnowshowers:'â„ï¸',
    lightsnow:'ğŸŒ¨ï¸', snow:'â„ï¸', heavysnow:'â„ï¸',
    rainandthunder:'â›ˆï¸', sleetandthunder:'â›ˆï¸', snowandthunder:'â›ˆï¸',
    lightrainandthunder:'â›ˆï¸', lightsleetandthunder:'â›ˆï¸', lightsnowandthunder:'â›ˆï¸',
    heavyrainandthunder:'â›ˆï¸', heavysleetandthunder:'â›ˆï¸', heavysnowandthunder:'â›ˆï¸'
  };
  return map[code] || 'ğŸŒ¡ï¸';
}

function getWeatherDescription(symbolCode) {
  const code = symbolCode.toLowerCase().replace(/_day|_night|_polartwilight/g,'');
  const map = {
    clearsky:'Klart', fair:'Mest klart', partlycloudy:'Halvklart', cloudy:'Mulet', fog:'Dimma',
    lightrainshowers:'LÃ¤tta regnskurar', rainshowers:'Regnskurar', heavyrainshowers:'Kraftiga regnskurar',
    lightrain:'Duggregn', rain:'Regn', heavyrain:'Kraftigt regn',
    lightsleetshowers:'LÃ¤tta snÃ¶blandat skurar', sleetshowers:'SnÃ¶blandat regn', heavysleetshowers:'Kraftiga snÃ¶blandat skurar',
    lightsleet:'LÃ¤tt snÃ¶blandat regn', sleet:'SnÃ¶blandat regn', heavysleet:'Kraftigt snÃ¶blandat regn',
    lightsnowshowers:'LÃ¤tt snÃ¶fall', snowshowers:'SnÃ¶fall', heavysnowshowers:'Kraftigt snÃ¶fall',
    lightsnow:'LÃ¤tt snÃ¶', snow:'SnÃ¶fall', heavysnow:'Kraftigt snÃ¶fall',
    rainandthunder:'Ã…ska', sleetandthunder:'SnÃ¶blandat & Ã…ska', snowandthunder:'SnÃ¶ & Ã…ska',
    lightrainandthunder:'LÃ¤tt regn & Ã…ska', lightsleetandthunder:'LÃ¤tt snÃ¶blandat & Ã…ska',
    lightsnowandthunder:'LÃ¤tt snÃ¶ & Ã…ska', heavyrainandthunder:'Kraftigt Ã¥ska',
    heavysleetandthunder:'Kraftigt snÃ¶blandat & Ã…ska', heavysnowandthunder:'Kraftigt snÃ¶ & Ã…ska'
  };
  return map[code] || 'OkÃ¤nt';
}

// â”€â”€ GEOCODING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function searchCity() {
  const cityName = document.getElementById('citySearchInput').value.trim();
  if (!cityName) { showError('Ange ett stadsnamn'); return; }
  const btn = document.querySelector('.pill-btn');
  btn.disabled = true; btn.textContent = 'â€¦';
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&format=json&limit=1`,{ headers:{'User-Agent':'WeatherDashboard/1.0'} });
    if (!res.ok) throw new Error();
    const data = await res.json();
    if (!data.length) { showError(`Hittade inte "${cityName}"`); return; }
    const loc = data[0];
    const lat = parseFloat(loc.lat), lon = parseFloat(loc.lon);
    document.getElementById('lat').value = lat.toFixed(6);
    document.getElementById('lon').value = lon.toFixed(6);
    await selectCity(loc.display_name, lat, lon);
  } catch { showError('SÃ¶kning misslyckades. FÃ¶rsÃ¶k igen.'); }
  finally { btn.disabled = false; btn.textContent = 'ğŸ” SÃ¶k'; }
}

async function selectCity(name, lat, lon) {
  currentCity = name;
  document.getElementById('lat').value = lat;
  document.getElementById('lon').value = lon;
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  if (event?.target?.classList.contains('preset-btn')) event.target.classList.add('active');
  await fetchWeather();
}

function useGeolocation() {
  if (!navigator.geolocation) { showError('Geolokalisering stÃ¶ds inte'); return; }
  const btn = event.target; btn.textContent = 'ğŸ“ HÃ¤mtarâ€¦'; btn.disabled = true;
  navigator.geolocation.getCurrentPosition(
    pos => {
      document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
      document.getElementById('lon').value = pos.coords.longitude.toFixed(6);
      currentCity = 'Min plats';
      fetchWeather().finally(() => { btn.textContent = 'ğŸ“ Min plats'; btn.disabled = false; });
    },
    err => { showError('Kunde inte hÃ¤mta plats: ' + err.message); btn.textContent = 'ğŸ“ Min plats'; btn.disabled = false; }
  );
}

// â”€â”€ DATA FETCH & PROCESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function fetchWeather() {
  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  if (isNaN(lat)||isNaN(lon)) { showError('Ogiltiga koordinater'); return; }

  document.getElementById('loading').style.display = 'block';
  document.getElementById('content').style.display = 'none';
  document.getElementById('error').style.display = 'none';

  try {
    const res = await fetch(`https://api.met.no/weatherapi/locationforecast/2.0/complete?lat=${lat}&lon=${lon}`,{ headers:{'User-Agent':'WeatherDashboard/1.0 (educational)'} });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    processWeatherData(data);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('content').style.display = 'flex';
    document.getElementById('locationLabel').textContent = currentCity;
    setRange(currentRange);
  } catch(e) {
    showError('Kunde inte hÃ¤mta vÃ¤derdata: ' + e.message);
    document.getElementById('loading').style.display = 'none';
  }
}

function processWeatherData(data) {
  const times=[], temp=[], temp_p10=[], temp_p90=[], feels_like=[];
  const wind=[], wind_p10=[], wind_p90=[], gust=[], wind_direction=[];
  const precip=[], precip_p10=[], precip_p90=[], precip_prob=[];
  const cloud=[], humidity=[], pressure=[], uv=[], symbols=[];

  data.properties.timeseries.forEach(entry => {
    const t = new Date(entry.time);
    const inst = entry.data.instant.details;
    const next1h = entry.data.next_1_hours;
    const next6h = entry.data.next_6_hours;

    times.push(t);
    temp.push(inst.air_temperature);
    temp_p10.push(inst.air_temperature_percentile_10 || inst.air_temperature);
    temp_p90.push(inst.air_temperature_percentile_90 || inst.air_temperature);
    feels_like.push(calculateFeelsLike(inst.air_temperature, inst.wind_speed, inst.relative_humidity));
    wind.push(inst.wind_speed);
    wind_p10.push(inst.wind_speed_percentile_10 || inst.wind_speed);
    wind_p90.push(inst.wind_speed_percentile_90 || inst.wind_speed);
    gust.push(inst.wind_speed_of_gust || inst.wind_speed * 1.5);
    wind_direction.push(inst.wind_from_direction);

    if (next1h) {
      precip.push(next1h.details.precipitation_amount);
      precip_p10.push(next1h.details.precipitation_amount_min || next1h.details.precipitation_amount);
      precip_p90.push(next1h.details.precipitation_amount_max || next1h.details.precipitation_amount);
      precip_prob.push(next1h.details.probability_of_precipitation ?? null);
      symbols.push(next1h.summary?.symbol_code || 'unknown');
    } else if (next6h) {
      // Fall back to 6-hour data (divide by 6 to get hourly rate approximation)
      const precip6h = next6h.details.precipitation_amount || 0;
      precip.push(precip6h / 6);
      precip_p10.push((next6h.details.precipitation_amount_min || precip6h) / 6);
      precip_p90.push((next6h.details.precipitation_amount_max || precip6h) / 6);
      precip_prob.push(next6h.details.probability_of_precipitation ?? null);
      symbols.push(next6h.summary?.symbol_code || 'unknown');
    } else {
      precip.push(null); precip_p10.push(null); precip_p90.push(null); precip_prob.push(null);
      symbols.push('unknown');
    }
    cloud.push(inst.cloud_area_fraction);
    humidity.push(inst.relative_humidity);
    pressure.push(inst.air_pressure_at_sea_level);
    uv.push(inst.ultraviolet_index_clear_sky || 0);
  });

  weatherData = { times, data: { temp, temp_p10, temp_p90, feels_like, wind, wind_p10, wind_p90, gust, wind_direction, precip, precip_p10, precip_p90, precip_prob, cloud, humidity, pressure, uv, symbols } };
}

// â”€â”€ SLICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function sliceData(hours) {
  const n = hours === 9999 ? weatherData.times.length : Math.min(weatherData.times.length, hours);
  return {
    times: weatherData.times.slice(0, n),
    data: Object.fromEntries(Object.entries(weatherData.data).map(([k,v]) => [k, v.slice(0,n)]))
  };
}

// â”€â”€ RANGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function setRange(hours) {
  currentRange = hours;
  document.querySelectorAll('.range-tab').forEach(b => b.classList.remove('active'));
  const id = hours === 9999 ? 'btn-all' : `btn-${hours}`;
  const btn = document.getElementById(id);
  if (btn) btn.classList.add('active');
  updateCurrentCards();
  updateRiskBadges();
  drawCharts();
  updateTable();
}

// â”€â”€ CURRENT CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateCurrentCards() {
  const d = weatherData.data;
  const s = sliceData(currentRange);

  // Temperature card
  const tm = s.data.temp, fl0 = s.data.feels_like;
  const meanT = tm.reduce((a,b) => a + (b || 0), 0) / tm.length;
  const meanF = fl0.reduce((a,b) => a + (b || 0), 0) / fl0.length;
  document.getElementById('cTemp').textContent = meanT != null ? `${meanT.toFixed(1)}Â°C` : 'â€”';
  document.getElementById('cTempRange').textContent = `Min${Math.min(...tm).toFixed(0)}Â°C, Max ${Math.max(...tm).toFixed(0)}Â°C`

  // Wind card
  const wm = s.data.wind, gm = s.data.gust, wd = s.data.wind_direction;
  const meanW = wm.reduce((a,b) => a + (b || 0), 0) / wm.length;
  const meanD = wd.reduce((a,b) => a + (b || 0), 0) / wd.length;
  document.getElementById('cWind').textContent = meanW != null ? `${meanW.toFixed(1)} m/s` : 'â€”';
  document.getElementById('cWindsub').textContent = `Max ${Math.max(...wm)?.toFixed(0) || 'â€”'}(${Math.max(...gm)?.toFixed(0) || 'â€”'}) m/s Â· ${getWindDirection(meanD) || 'â€”'}`;

  // Precip card
  const pm = s.data.precip, probs = s.data.precip_prob;
  const meanP = pm.reduce((a,b) => a + (b || 0), 0) / pm.length;
  document.getElementById('cPrecip').textContent = meanP != null ? `${meanP.toFixed(1)} mm/h` : '0 mm';
  const totalP = s.data.precip.reduce((a,b) => a+(b||0), 0);
  const windowProb = 1 - probs.reduce((acc, p) => {
  const prob = Math.min(Math.max((p || 0) / 100, 0), 1);
  return acc * (1 - prob);
}, 1);
  windowProbPercent = Math.round(windowProb * 100);
  document.getElementById('cPrecipSub').innerHTML = `FÃ¶rvÃ¤ntat ${totalP.toFixed(1)} mm <br> ${windowProbPercent != null ? windowProbPercent.toFixed(0)+'%' : 'â€”'} risk fÃ¶r nederb.`;

  // Cloud
  const cloud = s.data.cloud
  const meanC = cloud.reduce((a,b) => a + (b || 0), 0) / cloud.length;
  document.getElementById('cCloud').textContent = meanC != null ? `${meanC.toFixed(0)}%` : 'â€”';
  document.getElementById('cCloudRange').textContent = `${Math.min(...cloud).toFixed(0)}â€“${Math.max(...cloud).toFixed(0)}%`;

  // Humidity
  const hum = s.data.humidity
  const meanH = hum.reduce((a,b) => a + (b || 0), 0) / hum.length;
  document.getElementById('cHumidity').textContent = meanH != null ? `${meanH.toFixed(0)}%` : 'â€”';
  document.getElementById('cHumidityRange').textContent = `${Math.min(...hum).toFixed(0)}â€“${Math.max(...hum).toFixed(0)}%`;

  // Pressure
  const pres = s.data.pressure
  const meanPr = pres.reduce((a,b) => a + (b || 0), 0) / pres.length;
  document.getElementById('cPressure').textContent = meanPr != null ? `${meanPr.toFixed(0)}` : 'â€”';
  document.getElementById('cPressureRange').textContent = `${Math.min(...pres).toFixed(0)}â€“${Math.max(...pres).toFixed(0)} hPa`;

  // UV
  const uv = s.data.uv
  const meanUV = uv.reduce((a,b) => a + (b || 0), 0) / uv.length;
  document.getElementById('cUV').textContent = meanUV != null ? meanUV.toFixed(1) : 'â€”';
  document.getElementById('cUVRange').textContent = `Max ${Math.max(...uv).toFixed(1)}`;

  // Sparklines inside cards â€” hoverable, no staticPlot
  const sc = { displayModeBar: false, responsive: true };
  const sl = {
    margin: {t:2,r:2,b:2,l:2},
    xaxis: { visible:false, fixedrange:true },
    yaxis: { visible:false, fixedrange:true },
    showlegend: false,
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    height: 40,
    autosize: true,
    dragmode: false,
    hovermode: 'x'
  };

  const mk = (color, y, unit) => [{
    x: s.times, y,
    type: 'scatter', mode: 'lines',
    fill: 'tozeroy',
    line: { color, width: 1.5 },
    fillcolor: color.replace(')', ',0.15)').replace('rgb','rgba'),
    hovertemplate: `%{x|%b %d %H:%M}<br>%{y:.1f}${unit}<extra></extra>`
  }];

  Plotly.newPlot('sparkTemp',     mk('--accent)',  s.data.temp,     ' Â°C',), sl, sc,);
  Plotly.newPlot('sparkWind',     mk('rgb(52,211,153)',  s.data.wind,     ' m/s',), sl, sc,);
  Plotly.newPlot('sparkPrecip',     mk('(--cyan)',  s.data.precip,     ' mm',), sl, sc,);
  Plotly.newPlot('sparkCloud',    mk('rgb(148,163,184)', s.data.cloud,    '%',),    sl, sc,);
  Plotly.newPlot('sparkHumidity', mk('rgb(167,139,250)', s.data.humidity, '%',),    sl, sc,);
  Plotly.newPlot('sparkPressure', mk('rgb(251,191,36)',  s.data.pressure, ' hPa',),sl, sc,);
  Plotly.newPlot('sparkUV',       mk('rgb(249,115,22)',  s.data.uv,       '',),    sl, sc,);
}

// â”€â”€ RISK BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateRiskBadges() {
  const s = sliceData(currentRange);
  const maxTemp = Math.max(...s.data.temp), minTemp = Math.min(...s.data.temp);
  const maxWind = Math.max(...s.data.wind), maxGust = Math.max(...s.data.gust);
  const maxUV   = Math.max(...s.data.uv);
  const totalP  = s.data.precip.reduce((a,b)=>a+(b||0),0);
  const label   = currentRange === 9999 ? 'Samtliga' : `${currentRange}h`;

  const badge = (icon, text, cls) =>
    `<div class="risk-badge ${cls}"><span class="risk-badge-icon">${icon}</span>${text}</div>`;

  document.getElementById('riskRow').innerHTML =
    badge('ğŸŒ¡ï¸', `${minTemp.toFixed(1)}Â° â†’ ${maxTemp.toFixed(1)}Â°`,
      maxTemp > 30 || minTemp < -10 ? 'high' : maxTemp > 25 || minTemp < 0 ? 'medium' : 'low') +
    badge('ğŸ’¨', `Max ${maxWind.toFixed(1)} m/s`,
      maxWind > 15 ? 'high' : maxWind > 10 ? 'medium' : 'low') +
    badge('ğŸŒªï¸', `Byar ${maxGust.toFixed(1)} m/s`,
      maxGust > 20 ? 'high' : maxGust > 15 ? 'medium' : 'low') +
    badge('â˜€ï¸', `UV ${maxUV.toFixed(1)}`,
      maxUV > 7 ? 'high' : maxUV > 3 ? 'medium' : 'low') +
    badge('ğŸŒ§ï¸', `${totalP.toFixed(1)} mm tot.`,
      totalP > 10 ? 'high' : totalP > 2 ? 'medium' : 'low');
}

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function drawCharts() {
  const s = sliceData(currentRange);
  const cfg = { 
  responsive: true, 
  displayModeBar: false, 
  scrollZoom: true,
  modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d'],
  doubleClick: 'reset',
  dragmode: 'zoom'
};

  const base = {
    margin: {t:10, r:40, b:45, l:50},
    height: 240,
    autosize: true,
    hovermode: 'x unified',
    plot_bgcolor: '#111827',
    paper_bgcolor: '#111827',
    font: { family: 'Inter, sans-serif', size: 11, color: '#7a94b8' },
    xaxis: { gridcolor:'#1f2e47', linecolor:'#1f2e47', tickfont:{color:'#4a6080', size:10}, fixedrange:false, tickangle: -25 },
    yaxis: { gridcolor:'#1f2e47', linecolor:'#1f2e47', tickfont:{color:'#4a6080', size:10}, fixedrange:false },
    legend: { orientation:'h', y:-0.45, x:0.5, xanchor:'center', font:{size:10}, bgcolor:'rgba(0,0,0,0)' },
    dragmode: false,
    hoverlabel: { bgcolor:'#1a2438', bordercolor:'#2d4060', font:{family:'Inter, sans-serif', size:12, color:'#e2eaf7'} }
  };

  // â”€â”€ TEMP â”€â”€
  document.getElementById('chartTempLive').innerHTML =
   `<span class="blink">â—</span> ${s.data.temp[0]?.toFixed(1)||'â€”'}Â°C Â· KÃ¤nns ${s.data.feels_like[0]?.toFixed(1)||'â€”'}Â°C`;

  Plotly.newPlot('tempChart', [
    { x:s.times, y:s.data.temp_p10, type:'scatter', mode:'lines', line:{width:0}, showlegend:false, fill:'none', hovertemplate:'Min: %{y:.1f}Â°C<extra></extra>' },
    { x:s.times, y:s.data.temp_p90, type:'scatter', mode:'lines', fill:'tonexty', fillcolor:'rgba(56,189,248,0.1)', line:{width:1,color:'rgba(56,189,248,0.2)'}, name:'P10â€“P90', hovertemplate:'P90: %{y:.1f}Â°C<extra></extra>' },
    { x:s.times, y:s.data.temp,     type:'scatter', mode:'lines', line:{color:'#38bdf8',width:2.5}, name:'Temp', hovertemplate:'%{y:.1f}Â°C<extra></extra>' },
    { x:s.times, y:s.data.feels_like, type:'scatter', mode:'lines', line:{color:'#a78bfa',width:1.5,dash:'dot'}, name:'KÃ¤nns som', hovertemplate:'KÃ¤nns: %{y:.1f}Â°C<extra></extra>' }
  ], { ...base, yaxis:{...base.yaxis, title:{text:'Â°C', font:{size:11, color:'#4a6080'}}} }, cfg);

  // â”€â”€ WIND â”€â”€
  const windDir0 = s.data.wind_direction[0];
  document.getElementById('chartWindLive').innerHTML =
   `<span class="blink">â—</span>${s.data.wind[0]?.toFixed(1)||'â€”'} m/s Â· Byar ${s.data.gust[0]?.toFixed(1)||'â€”'} m/s Â· ${getWindDirection(windDir0)}`;

  const showEveryN = Math.max(1, Math.floor(s.times.length / 12));
  const windAnnotations = [];
  for (let i = 0; i < s.times.length; i += showEveryN) {
    if (s.data.wind_direction[i] !== null && s.data.wind[i] > 0.5) {
      windAnnotations.push({ x:s.times[i], y:s.data.wind[i], text:'â†“', showarrow:false, font:{size:22,color:'rgb(255, 255, 255)'}, textangle:s.data.wind_direction[i] % 360, xanchor:'center', yanchor:'middle' });
    }
  }

  Plotly.newPlot('windChart', [
    { x:s.times, y:s.data.wind_p10, type:'scatter', mode:'lines', line:{width:0}, showlegend:false, fill:'none', hovertemplate:'P10: %{y:.1f} m/s<extra></extra>'},
    { x:s.times, y:s.data.wind_p90, type:'scatter', mode:'lines', fill:'tonexty', fillcolor:'rgba(52,211,153,0.1)', line:{width:1,color:'rgba(52,211,153,0.2)'}, name:'P10â€“P90', hovertemplate:'P90: %{y:.1f} m/s<extra></extra>' },
    { x:s.times, y:s.data.wind,     type:'scatter', mode:'lines', line:{color:'#34d399',width:2.5}, name:'Medelvind', hovertemplate:'%{y:.1f} m/s<extra></extra>' },
    { x:s.times, y:s.data.gust,     type:'scatter', mode:'lines', line:{color:'#fbbf24',width:1.5,dash:'dash'}, name:'Byvind', hovertemplate:'Byar: %{y:.1f} m/s<extra></extra>' }
  ], { ...base, annotations:windAnnotations, yaxis:{...base.yaxis, title:{text:'m/s', font:{size:11, color:'#4a6080'}}} }, cfg);

  // â”€â”€ PRECIP â”€â”€
  document.getElementById('chartPrecipLive').innerHTML =
   `<span class="blink">â—</span>${s.data.precip[0]?.toFixed(1)||'0.0'} mm`;

  const pd = s.times.map((_,i) => ({
    t:s.times[i], p:s.data.precip[i]||0, p10:s.data.precip_p10[i]||0,
    p90:s.data.precip_p90[i]||0, prob:s.data.precip_prob[i]
  }));

  const cumulativeProb = [];
  let runningProb = 1.0; // Start with 100% chance of NO precip
  for (let i = 0; i < pd.length; i++) {
    const hourProb = Math.min(Math.max((pd[i].prob || 0) / 100, 0), 1);
    runningProb *= (1 - hourProb); // Multiply by chance of NO precip
    cumulativeProb.push((1 - runningProb) * 100); // Convert back to percent chance of ANY precip
  }

  Plotly.newPlot('precipChart', [
    { x:pd.map(d=>d.t), y:pd.map(d=>d.p10), type:'scatter', mode:'lines', line:{width:0}, showlegend:false, fill:'none', hovertemplate:'Min: %{y:.1f} mm<extra></extra>' },
    { x:pd.map(d=>d.t), y:pd.map(d=>d.p90), type:'scatter', mode:'lines', fill:'tonexty', fillcolor:'rgba(103,232,249,0.1)', line:{width:1,color:'rgba(103,232,249,0.2)'}, name:'Minâ€“Max', hovertemplate:'Max: %{y:.1f} mm<extra></extra>' },
    { x:pd.map(d=>d.t), y:pd.map(d=>d.p),   type:'scatter', mode:'lines', line:{color:'#67e8f9',width:2.5}, name:'Nederb', hovertemplate:'%{y:.1f} mm<extra></extra>' },
    { x:pd.map(d=>d.t), y:pd.map(d=>d.prob), type:'scatter', mode:'lines', yaxis:'y2', line:{color:'#f97316',width:1.5,dash:'dot'}, name:'Sannolikhet', hovertemplate:'Prob %{y:.0f}%<extra></extra>' },
    { x:pd.map(d=>d.t), y:cumulativeProb, type:'scatter', mode:'lines', yaxis:'y2', line:{color:'#fbbf24',width:2,dash:'dash'}, name:'Kumulativ risk', hovertemplate:'Kumulativ: %{y:.0f}%<extra></extra>' }
  ], {
    ...base,
    yaxis:{...base.yaxis, title:{text:'mm', font:{size:11, color:'#4a6080'}}},
    yaxis2:{ overlaying:'y', side:'right', range:[0,100], gridcolor:'rgba(0,0,0,0)', linecolor:'#1f2e47', tickfont:{color:'#f97316', size:10}, titlefont:{color:'#f97316'}, title:{text:'%', font:{size:11}}, fixedrange:true }
  }, cfg);
}

// â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateTable() {
  const s = sliceData(currentRange);
  const tbody = document.getElementById('weatherDataBody');
  tbody.innerHTML = '';

  for (let i = 0; i < s.times.length; i++) {
    const row = tbody.insertRow();

    // Time
    const tc = row.insertCell();
    tc.className = 'time-cell';
    tc.textContent = s.times[i].toLocaleString('sv-SE', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });

    // Condition
    const cc = row.insertCell();
    const emoji = getWeatherEmoji(s.data.symbols[i]);
    const desc  = getWeatherDescription(s.data.symbols[i]);
    cc.innerHTML = `<div class="cond-cell"><span>${emoji}</span><span>${desc}</span></div>`;

    // Temp with percentiles
    const tv = s.data.temp[i], tp10 = s.data.temp_p10[i], tp90 = s.data.temp_p90[i];
    const tempCell = row.insertCell();
    tempCell.className = 'highlight';
    if (tv != null) {
      const cls = tv > 25 ? 'temp-hot' : tv < 0 ? 'temp-cold' : 'temp-norm';
      tempCell.innerHTML = `<span class="${cls}">${tv.toFixed(1)}</span> <span style="color:var(--muted);font-size:0.65rem">[${tp10.toFixed(1)}, ${tp90.toFixed(1)}]</span>`;
    } else { tempCell.textContent = 'â€”'; }

    // Feels like
    const fl = s.data.feels_like[i];
    const flCell = row.insertCell();
    if (fl != null) flCell.textContent = fl.toFixed(1);
    else flCell.textContent = 'â€”';

    // Wind
    const wv = s.data.wind[i], gv = s.data.gust[i], wd = getWindDirection(s.data.wind_direction[i]) ;
    const wCell = row.insertCell();
    if (wv != null) {
      wCell.className = wv > 15 ? 'wind-high' : wv > 10 ? 'wind-med' : '';
      wCell.innerHTML = `<span class="${wCell}">${wv.toFixed(1)}</span> <span style="color:var(--muted)">(${gv.toFixed(1)}) ${wd}</span>`;
      // wCell.textContent = wv.toFixed(1);
    } else { wCell.textContent = 'â€”'; }

    // Wind direction
    // row.insertCell().textContent = getWindDirection(s.data.wind_direction[i]);

    // Gust
    // const gv = s.data.gust[i];
    // const gCell = row.insertCell();
    // if (gv != null) {
    //   gCell.className = gv > 20 ? 'wind-high' : gv > 15 ? 'wind-med' : '';
    //   gCell.textContent = gv.toFixed(1);
    // } else { gCell.textContent = 'â€”'; }

    // Precip
    const pv = s.data.precip[i], pp10 = s.data.precip_p10[i], pp90 = s.data.precip_p90[i], pprob = s.data.precip_prob[i];
    const pCell = row.insertCell();
    if (pv != null) {
      pCell.className = pv > 0.1 ? 'precip-wet' : '';
      const probStr = pprob != null ? ` ${pprob.toFixed(0)}%` : '';
      pCell.innerHTML = `${pv.toFixed(1)} <span style="color:var(--muted);font-size:0.65rem">[${pp10.toFixed(1)}, ${pp90.toFixed(1)}]${probStr}</span>`;
    } else { pCell.textContent = 'â€”'; }

    // Cloud
    row.insertCell().textContent = s.data.cloud[i]?.toFixed(0) ?? 'â€”';
    // Humidity
    row.insertCell().textContent = s.data.humidity[i]?.toFixed(0) ?? 'â€”';
    // Pressure
    row.insertCell().textContent = s.data.pressure[i]?.toFixed(1) ?? 'â€”';
    // UV
    row.insertCell().textContent = s.data.uv[i]?.toFixed(1) ?? 'â€”';
  }
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
  selectCity('SkellefteÃ¥', 64.762519, 20.923440);
});
</script>
</body>
</html>
